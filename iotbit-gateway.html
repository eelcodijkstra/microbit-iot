

<!DOCTYPE html>


<html lang="nl" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>iot:bit als gateway &#8212; IoT met de microbit</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="_static/assessment.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="_static/assessment.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/translations.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'iotbit-gateway';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Zoeken" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="nl"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
    <p class="title logo__title">IoT met de micro:bit</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="inleiding.html">Inleiding</a></li>
<li class="toctree-l1"><a class="reference internal" href="benodigd.html">Wat heb je nodig?</a></li>
<li class="toctree-l1"><a class="reference internal" href="overzicht.html">Overzicht</a></li>
<li class="toctree-l1"><a class="reference internal" href="bijeenkomst-1.html">Bijeenkomst 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="bijeenkomst-2.html">Bijeenkomst 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="bijeenkomst-3.html">Bijeenkomst 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="lpp-payload.html">LPP payload formaat</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-editor.html">Python op de microbit</a></li>
<li class="toctree-l1"><a class="reference internal" href="microbits-programmeren.html">Programmeren van de micro:bits</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="microbit-software.html">micro:bit software</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="microbit-iotnode.html">microbit IoT-knoop</a></li>
<li class="toctree-l2"><a class="reference internal" href="microbit-logger.html">radio-logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="espat-gateway.html">ESP-AT gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="espat-module.html">ESP-AT module</a></li>
<li class="toctree-l2"><a class="reference internal" href="lpp-module.html">LPP implementatie</a></li>
<li class="toctree-l2"><a class="reference internal" href="json-module.html">JSON voor de microbit</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="presentaties.html">Presentaties</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="presentatie-1.html">Presentatie-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="presentatie-2.html">Presentatie 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="presentatie-3.html">Presentatie 3</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download deze pagina">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/iotbit-gateway.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download het bronbestand"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Afdrukken naar pdf"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Volledig scherm"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Zoeken" aria-label="Zoeken" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>iot:bit als gateway</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Inhoud </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#programmeren-van-de-micro-bit-als-gateway">Programmeren van de micro:bit als gateway</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#uitleg-van-de-gateway-code">Uitleg van de gateway-code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-loop">Main loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gebruik-van-timers-alternatief">Gebruik van timers? Alternatief?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#on-data-received-functie">on data received functie</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging">Debugging</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gebruik-van-radio-voor-logging-debugging">Gebruik van radio voor logging, debugging</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#voorbeelden">Voorbeelden</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#voorbereidden-van-de-mqtt-connect">Voorbereidden van de MQTT connect</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#at-messages">AT messages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mqtt">MQTT</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organiseren-als-library">Organiseren als library</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#atesp-library">atesp library</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="iot-bit-als-gateway">
<h1>iot:bit als gateway<a class="headerlink" href="#iot-bit-als-gateway" title="Permalink naar deze titel">#</a></h1>
<p>We gebruiken de Elecfreaks iot:bit samen met een micro:bit V2(!) als iot-gateway voor een lokaal netwerk van micro:bits.</p>
<p>Dit bordje beschikt over een ESP8266-module voor een WiFi-verbinding met het lokale netwerk.
Deze module heeft bovendien HTTP(S) en MQTT-protocollen ingebouwd.</p>
<p>Voor de aansturing van deze module wordt de (enige) seriële (UART) verbinding van de micro:bit gebruikt.
Hierover worden “AT”-opdrachten verstuurd naar de module.
De baudrate van deze verbinding is 115200.
De gebruikte pins staan gedocumenteerd op het bordje: microbit Rx in pin12, Tx is pin8.</p>
<p>Een beschrijving van de beschikbare AT-opdrachten is te vinden in de documentatie: <a class="reference external" href="https://docs.espressif.com/projects/esp-at/en/release-v2.1.0.0_esp8266/AT_Command_Set/MQTT_AT_Commands.html#cmd-MQTTCONN">https://docs.espressif.com/projects/esp-at/en/release-v2.1.0.0_esp8266/AT_Command_Set/MQTT_AT_Commands.html#cmd-MQTTCONN</a></p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.elecfreaks.com/iot-bit-for-micro-bit.html">https://www.elecfreaks.com/iot-bit-for-micro-bit.html</a></p></li>
<li><p><a class="reference external" href="https://www.elecfreaks.com/learn-en/microbitKit/iot_kit/iot_bit.html">https://www.elecfreaks.com/learn-en/microbitKit/iot_kit/iot_bit.html</a> (wiki)</p></li>
</ul>
<section id="programmeren-van-de-micro-bit-als-gateway">
<h2>Programmeren van de micro:bit als gateway<a class="headerlink" href="#programmeren-van-de-micro-bit-als-gateway" title="Permalink naar deze titel">#</a></h2>
<p><strong>LET OP.</strong> Voor het programmeren moet je de microbit uit het iot:bit bordje halen: je mag de microbit niet met de host verbinden als deze een voedingsspanning krijgt via het iot:bit bordje.</p>
<p>Het gateway-programma gebruikt twee extra libraries, deze moet je eerst laden in de editor.</p>
</section>
<section id="uitleg-van-de-gateway-code">
<h2>Uitleg van de gateway-code<a class="headerlink" href="#uitleg-van-de-gateway-code" title="Permalink naar deze titel">#</a></h2>
<blockquote>
<div><p>Omdat er maar één UART verbinding tegelijk mogelijk is, kan de communicatie met de ESP8266 niet gecombineerd worden met de verbinding met de host. Dit betekent dat bijv. print-opdrachten dan niet mogelijk zijn (debugging!). Dit betekent dat we naar andere vormen van debugging moeten zoeken, bijv. via het display?</p>
<p>Dat is waarschijnlijk ook wel aantrekkelijk om de status van de gateway, bijvoorbeeld bij het opstarten, te kunnen volgen.</p>
</div></blockquote>
<p>Bij de AT-opdrachten zijn de volgende zaken van belang:</p>
<ul class="simple">
<li><p>je moet een bepaalde periode wachten voordat je de volgende opdracht geeft.</p>
<ul>
<li><p>dat wordt in de onderstaande code uitgewerkt als “basic.pause(time)” - maar uiteindelijk willen we daarvoor liever een oplossing met timers gebruiken, in plaats van een dergelijke blokkerende actie.</p></li>
</ul>
</li>
<li><p>de AT-opdrachten komen gewoonlijk met een response, als reactie op de AT-opdracht. In principe kun je pas de volgende opdracht geven na ontvangst van deze response. (Je hebt dan geen timer nodig???)</p></li>
<li><p>soms komt er (tussendoor) een onverwacht (asynchroon) bericht van de module, bijvoorbeeld bij de ontvangst van een MQTT-bericht. Dit is dan niet op basis van een direct voorafgaande AT-opdracht.</p>
<ul>
<li><p>hoe herken je een dergelijk asynchroon bericht?</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sendAT</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="c1"># basic.pause(wait)</span>
</pre></div>
</div>
</div>
</div>
<p>(Gebruik van Python templates: <code class="docutils literal notranslate"><span class="pre">f'..string...{var}...'</span></code> - is dat een var, of zelfs een expr?).</p>
<p>(Hierboven, gebruik van <code class="docutils literal notranslate"><span class="pre">microbit.sleep(ms)</span></code>; alternatief is het gebruik van <code class="docutils literal notranslate"><span class="pre">utime.sleep_ms</span></code>. Wat is het verschil?)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resetEsp8266</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RESTORE&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># restore to factory settings</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>     <span class="c1"># reset, restart</span>
    <span class="n">serial</span><span class="o">.</span><span class="n">readString</span><span class="p">()</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWMODE=1&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="c1"># set to STA mode</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+SYSTIMESTAMP=1634953609130&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="c1"># Set local timestamp.</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSNTPCFG=1,8,&quot;ntp1.aliyun.com&quot;,&quot;0.pool.ntp.org&quot;,&quot;time.google.com&quot;&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Uit de Espressif documentatie (van een oudere versie…)</p>
<p>Notes:</p>
<ol class="arabic simple">
<li><p>Not all AT Command has four commands.</p></li>
<li><p>[] = default value, not required or may not appear`</p></li>
<li><p>String values require double quotation marks, for example: <code class="docutils literal notranslate"><span class="pre">AT+CWSAP=&quot;ESP756290&quot;,</span> <span class="pre">&quot;21030826&quot;,</span> <span class="pre">1,</span> <span class="pre">4</span></code></p></li>
<li><p>Baudrate = 115200</p></li>
<li><p>AT Commands has to be capitalized, and end with “/r/n”</p></li>
</ol>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_ESP8266_connection</span><span class="p">():</span>
    <span class="nb">set</span> <span class="n">serial</span> <span class="n">pins</span><span class="p">:</span> <span class="n">Tx</span><span class="o">=</span><span class="n">pin8</span> <span class="p">,</span> <span class="n">Rx</span><span class="o">=</span><span class="n">pin12</span>
    <span class="nb">set</span> <span class="n">baudrate</span> <span class="mi">115200</span>
</pre></div>
</div>
<p>microbit.uart.init(baudrate=115200,tx=pin8,rx=pin12)</p>
<p><strong>Opmerking:</strong> <code class="docutils literal notranslate"><span class="pre">microbit.uart.init(baudrate=115200)</span></code> herstelt de verbinding met de host (via USB).</p>
</section>
<section id="main-loop">
<h2>Main loop<a class="headerlink" href="#main-loop" title="Permalink naar deze titel">#</a></h2>
<p>Er kunnen berichten komen van verschillende kanten (en op willekeurige momenten)</p>
<ul class="simple">
<li><p>een radio-bericht van een microbit in het netwerk</p></li>
<li><p>een MQTT-bericht vanuit het internet</p>
<ul>
<li><p>via “subscribe”</p></li>
</ul>
</li>
</ul>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">uart</span>


<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">in_buffer</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">in_bytes</span><span class="p">)</span>
        <span class="c1"># may contain CRLF?</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">radio</span><span class="o">.</span><span class="n">receive_bytes</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1"># message from microbit in local network</span>
</pre></div>
</div>
</section>
<section id="gebruik-van-timers-alternatief">
<h2>Gebruik van timers? Alternatief?<a class="headerlink" href="#gebruik-van-timers-alternatief" title="Permalink naar deze titel">#</a></h2>
<p>Hoe kunnen we op een andere manier omgaan met de interactie tussen de microbit en de ESP8266, zodat er geen “sleep” meer nodig is?</p>
<ul class="simple">
<li><p>in principe geeft een opdracht altijd een response, ten teken dat deze uitgevoerd is, al dan niet met fouten.</p></li>
<li><p>je kunt wachten op deze response, voordat je een volgende opdracht geeft. Maar hoe programmeer je dat netjes?</p>
<ul>
<li><p>vgl. de “promisse” aanpak? (Continuation meegeven als functie?)</p></li>
<li><p>gebruik van asyncio? (<a class="reference external" href="https://docs.micropython.org/en/latest/library/uasyncio.html">https://docs.micropython.org/en/latest/library/uasyncio.html</a>)</p></li>
<li><p>is deze beschikbaar voor de microbit? Staat niet beschreven in de microbit micropython documentatie.</p></li>
</ul>
</li>
</ul>
</section>
<section id="on-data-received-functie">
<h2>on data received functie<a class="headerlink" href="#on-data-received-functie" title="Permalink naar deze titel">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">serial</span><span class="o">.</span><span class="n">onDataReceived</span><span class="p">(</span><span class="n">serial</span><span class="o">.</span><span class="n">delimiters</span><span class="p">(</span><span class="n">Delimiters</span><span class="o">.</span><span class="n">NewLine</span><span class="p">),</span> <span class="n">function</span><span class="p">()</span> <span class="p">{})</span>
</pre></div>
</div>
<ul class="simple">
<li><p><a class="github reference external" href="https://github.com/elecfreaks/pxt-esp8266iot/blob/master/ESP8266.ts">elecfreaks/pxt-esp8266iot</a></p></li>
</ul>
<p>zie r. 364. De betreffende function wordt aangeroepen als er seriële input beschikbaar is - met daarin de genoemde delimiters. Deze input wordt verwerkt door de betreffende functie (en uit de input buffer verwijderd?)</p>
<ul class="simple">
<li><p>er wordt eerst gecontroleerd op “onverwachte input”, die niet samenhangt met een direct voorafgaande opdracht. - bijvoorbeeld, een binnenkomend MQTT bericht.</p></li>
<li><p>als het geen onverwachte input is, wordt afhankelijk van de direct voorafgaande opdracht, de input verwerkt.</p>
<ul>
<li><p>afhankelijk van de inhoud van de respons, kan de status van het systeem veranderen; bijvoorbeeld: wifi-verbinding OK, of MQTT-verbinding OK. Bepaalde acties zijn alleen mogelijk bij een bepaalde toestand.</p></li>
</ul>
</li>
</ul>
</section>
<section id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink naar deze titel">#</a></h2>
<p>Idee: gebruik de twee buttons van de microbit.</p>
<ul class="simple">
<li><p>button A: verbindt de microbit met de host, en schrijft de gebufferde debug-i/o weg</p>
<ul>
<li><p>we hebben dan een buffer nodig voor deze i/o; of een buffer van wat anders de print-opdrachten zouden zijn, voor debugging.</p></li>
</ul>
</li>
<li><p>button B: verbindt de microbit met de ESP8266, en initialiseert de buffers en de communicatie.</p></li>
</ul>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">uart</span>

<span class="n">debug_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">last_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># form of command: AT+cmd,arg0,arg1,arg2,arg3</span>

<span class="k">def</span> <span class="nf">sendAT</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="c1"># basic.pause(wait)</span>

<span class="k">def</span> <span class="nf">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">init_ESP8266</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RESTORE&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># restore to factory settings</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>     <span class="c1"># reset, restart</span>
    <span class="n">serial</span><span class="o">.</span><span class="n">readString</span><span class="p">()</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWMODE=1&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="c1"># set to STA mode    </span>
    

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">button_a</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">uart</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">)</span> <span class="c1"># connect to host</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">debug_buffer</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">button_b</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">uart</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">pin8</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">pin12</span><span class="p">)</span> <span class="c1"># connect to ESP8266</span>
        <span class="n">debug_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">init_ESP8266</span>
        
        
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">input_buffer</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">in_bytes</span><span class="p">)</span>
        <span class="n">eol_pos</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eol_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># get line and</span>
            <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove from input_buffer</span>
            <span class="n">debug_buffer</span> <span class="o">+=</span> <span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">line</span>
            <span class="n">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="gebruik-van-radio-voor-logging-debugging">
<h2>Gebruik van radio voor logging, debugging<a class="headerlink" href="#gebruik-van-radio-voor-logging-debugging" title="Permalink naar deze titel">#</a></h2>
<p>We kunnen op de iot:bit geen gebruik maken van de host-communicatie: er is geen verbinding via USB (deze wordt alleen gebruikt voor de voeding van het bordje?)</p>
<p>Je moet de microbit <strong>programmeren via de USB-verbinding op het microbit-bordje</strong>; deze mag niet tegelijk met de USB-verbinding op de iot-bit actief zijn. De suggestie is om de microbit bij het programmeren steeds uit de iot:bit te verwijderen.
(Je kunt de iot-bit ook uit zetten; dat lijkt mij handiger…)</p>
<p>Omdat er eigenlijk geen andere verbinding mogelijk is, willen we de radio gebruiken voor het versturen van debuggings-gegevens.</p>
<p>Code voor de <strong>debug-microbit:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="n">radio</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Remote logger&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">radio</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Code voor de test-microbit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="n">radio</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Test </span><span class="si">{x}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cnt</span><span class="p">))</span>
    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Code voor de gateway-microbit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">last_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># form of command: AT+cmd,arg0,arg1,arg2,arg3</span>

<span class="k">def</span> <span class="nf">sendAT</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{cmd}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">command</span><span class="p">))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="c1"># basic.pause(wait)</span>

<span class="k">def</span> <span class="nf">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">wifi_connected</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI GOT IP&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">init_ESP8266</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RESTORE&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># restore to factory settings</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>     <span class="c1"># reset, restart</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">buf</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWMODE=1&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="c1"># set to STA mode    </span>

<span class="k">def</span> <span class="nf">init_WiFi</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&quot;</span><span class="si">{ssid}</span><span class="s1">&quot;,&quot;</span><span class="si">{pw}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ssid</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">),</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;...connected??&quot;</span><span class="p">)</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTAMAC?&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTA?&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">radio</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        
    <span class="k">if</span> <span class="n">button_a</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;A pressed&quot;</span><span class="p">)</span>
        <span class="n">uart</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">pin8</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">pin12</span><span class="p">)</span> <span class="c1"># connect to ESP8266</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">init_ESP8266</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">button_b</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;B pressed&quot;</span><span class="p">)</span>
        <span class="n">init_WiFi</span><span class="p">()</span>
          
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">in_bytes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_buffer</span> <span class="o">+=</span> <span class="n">in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="c1"># radio.send(&#39;-&gt;&#39; + input_buffer + &#39;&lt;-\r\n&#39;)</span>

    <span class="n">eol_pos</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eol_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eol_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># get line and</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove from input_buffer</span>
        <span class="n">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Waaruit bestaat de initialisatie?</p>
<ul class="simple">
<li><p>initialisatie van de ESP8266</p></li>
<li><p>WiFi-verbinding (lukt niet altijd in 1 keer)</p></li>
<li><p>MQTT verbinding (idem; kan tussentijds wegvallen - ook door wegvallen van WiFi?)</p>
<ul>
<li><p>eigenlijk moeten we in de hoofdlus controleren of deze verbinding er nog is, eventueel met een time-out</p></li>
<li><p>pas als deze er niet is hoeven we op WiFi te controleren.</p></li>
</ul>
</li>
<li><p>MQTT subscriptie</p>
<ul>
<li><p>deze is steeds nodig als de verbinding met de broker (opnieuw) gemaakt is.</p></li>
</ul>
</li>
</ul>
<p>Maken van een MQTT-verbinding: (onderstaande is de Elecfreaks-JS-code)</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">connectMQTT</span><span class="p">(</span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="p">,</span><span class="w"> </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="nx">number</span><span class="p">,</span><span class="w"> </span><span class="nx">reconnect</span><span class="o">:</span><span class="w"> </span><span class="kr">boolean</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">mqtthost_def</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">host</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">rec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">reconnect</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">        </span><span class="nx">currentCmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Cmd</span><span class="p">.</span><span class="nx">ConnectMqtt</span>
<span class="w">        </span><span class="nx">sendAT</span><span class="p">(</span><span class="sb">`AT+MQTTCONN=0,&quot;</span><span class="si">${</span><span class="nx">host</span><span class="si">}</span><span class="sb">&quot;,</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">,</span><span class="si">${</span><span class="nx">rec</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">        </span><span class="nx">control</span><span class="p">.</span><span class="nx">waitForEvent</span><span class="p">(</span><span class="nx">EspEventSource</span><span class="p">,</span><span class="w"> </span><span class="nx">EspEventValue</span><span class="p">.</span><span class="nx">ConnectMqtt</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">mqttSubscribeQos</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">topic</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mqttSubscribeQos</span><span class="p">[</span><span class="nx">topic</span><span class="p">]</span>
<span class="w">            </span><span class="nx">sendAT</span><span class="p">(</span><span class="sb">`AT+MQTTSUB=0,&quot;</span><span class="si">${</span><span class="nx">topic</span><span class="si">}</span><span class="sb">&quot;,</span><span class="si">${</span><span class="nx">qos</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>in Python:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">connectMQTT</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reconnect</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">mqtt_host</span>
    <span class="n">mqtt_host</span> <span class="o">=</span> <span class="n">host</span>
    <span class="n">current</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;connectMQTT&quot;</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTCONN=0,&quot;</span><span class="si">{hostnm}</span><span class="s1">&quot;,</span><span class="si">{portnr}</span><span class="s1">,</span><span class="si">{rec}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">hostnm</span> <span class="o">=</span> <span class="n">host</span><span class="p">,</span> 
        <span class="n">portnr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> 
        <span class="n">rec</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">reconnect</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">))</span>
    <span class="o">...</span><span class="n">wait</span> <span class="k">for</span> <span class="n">event</span><span class="p">:</span> <span class="n">connectMQTT</span><span class="o">...</span>
    <span class="o">...</span><span class="n">subscribe</span> <span class="n">to</span> <span class="n">topics</span><span class="o">...</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>  <span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">line</span> <span class="mi">10</span>
    <span class="o">...</span><span class="n">wait</span> <span class="k">for</span> <span class="n">event</span><span class="p">:</span> <span class="n">connectMQTT</span><span class="o">...</span>
       <span class="o">^</span>
<span class="ne">SyntaxError</span>: invalid syntax
</pre></div>
</div>
</div>
</div>
<p>aoh(We hebben een lijst nodig van subscription-topics; die moeten we opgeven aan de broker. En bij een binnenkomend bericht moeten we nagaan of dat voor deze gateway bestemd is.)</p>
<p>Hoe implementeren we in dit geval van de “wait for event”? - dit betekent eigenlijk dat er gewacht wordt op een bepaald bericht van de ESP8266.</p>
<p>Kunnen er meerdere “events” tegelijk onderweg zijn? of worden die netjes sequentieel afgehandeld?</p>
<ul class="simple">
<li><p><em>in dit geval</em> heeft het geen zin om nieuwe opdrachten te sturen, zolang de MQTT-verbinding nog niet actief is.</p></li>
<li><p>we moeten die analyse voor alle gevallen maken?</p></li>
</ul>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Check if ESP8266 successfully connected to mqtt broker</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="c1">//% block=&quot;MQTT broker is connected&quot;</span>
<span class="w">    </span><span class="c1">//% subcategory=&quot;MQTT&quot; weight=24</span>
<span class="w">    </span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">isMqttBrokerConnected</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">mqttBrokerConnected</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * send message</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="c1">//% subcategory=MQTT weight=21</span>
<span class="w">    </span><span class="c1">//% blockId=sendMQTT block=&quot;publish %msg to Topic:%topic with Qos:%qos&quot;</span>
<span class="w">    </span><span class="c1">//% msg.defl=hello</span>
<span class="w">    </span><span class="c1">//% topic.defl=topic/1</span>
<span class="w">    </span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">publishMqttMessage</span><span class="p">(</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="p">,</span><span class="w"> </span><span class="nx">topic</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="p">,</span><span class="w"> </span><span class="nx">qos</span><span class="o">:</span><span class="w"> </span><span class="nx">QosList</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">sendAT</span><span class="p">(</span><span class="sb">`AT+MQTTPUB=0,&quot;</span><span class="si">${</span><span class="nx">topic</span><span class="si">}</span><span class="sb">&quot;,&quot;</span><span class="si">${</span><span class="nx">msg</span><span class="si">}</span><span class="sb">&quot;,</span><span class="si">${</span><span class="nx">qos</span><span class="si">}</span><span class="sb">,0`</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * disconnect MQTT broker</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="c1">//% subcategory=MQTT weight=15</span>
<span class="w">    </span><span class="c1">//% blockId=breakMQTT block=&quot;Disconnect from broker&quot;</span>
<span class="w">    </span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">breakMQTT</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">sendAT</span><span class="p">(</span><span class="s2">&quot;AT+MQTTCLEAN=0&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//% block=&quot;when Topic: %topic have new $message with Qos: %qos&quot;</span>
<span class="w">    </span><span class="c1">//% subcategory=MQTT weight=10</span>
<span class="w">    </span><span class="c1">//% draggableParameters</span>
<span class="w">    </span><span class="c1">//% topic.defl=topic/1</span>
<span class="w">    </span><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">MqttEvent</span><span class="p">(</span><span class="nx">topic</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="p">,</span><span class="w"> </span><span class="nx">qos</span><span class="o">:</span><span class="w"> </span><span class="nx">QosList</span><span class="p">,</span><span class="w"> </span><span class="nx">handler</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">mqttSubscribeHandlers</span><span class="p">[</span><span class="nx">topic</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">handler</span>
<span class="w">        </span><span class="nx">mqttSubscribeQos</span><span class="p">[</span><span class="nx">topic</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">qos</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>NB: voor de MQTT-verbinding moeten ook de username en password gezet worden (en het “schema” - via TCP, TLS, enz.?) Dit moet gebeuren voor de MQTTCONN.</p>
<p>Er zijn afzonderlijke opdrachten voor het zetten van de usernamen en password.</p>
<p>Hoe kunnen we nagaan of de MQTT-verbinding nog bestaat? Moeten we dat actief opvragen, of krijgen we daarvan automatisch bericht? (Idem, voor de WiFi-verbinding.)</p>
<p>Zie de MQTT notes achteraan:</p>
<blockquote>
<div><p>When the MQTT connection ends, it will prompt message <code class="docutils literal notranslate"><span class="pre">+MQTTDISCONNECTED:&lt;LinkID&gt;</span></code></p>
<p>When the MQTT connection established, it will prompt message <code class="docutils literal notranslate"><span class="pre">+MQTTCONNECTED:&lt;LinkID&gt;,&lt;scheme&gt;,&lt;&quot;host&quot;&gt;,port,&lt;&quot;path&quot;&gt;,&lt;reconnect&gt;</span></code></p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;echo&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;complete&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">ok_state</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">on_wifi_connected</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTAMAC?&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTA?&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_mqtt_connected</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">set_current</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">handle_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">ok_state</span><span class="p">,</span> <span class="n">current</span>

    <span class="c1"># first, handle unsollicited messages</span>

    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MQTTSUBRECV&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI CONNECTED&#39;</span><span class="p">):</span>
        <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI GOT IP&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># next,  handle complex (or all?) commands</span>

    <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CWJAP&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&#39;</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ok_state</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ok_state</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">wifi_connected</span><span class="p">:</span>
                <span class="n">on_wifi_connected</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="c1"># else:</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-1: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="n">current</span><span class="o">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;MQTTCONN&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AT+MQTTCONN=&#39;</span><span class="p">):</span>
            <span class="n">current</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">):</span>
            <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">):</span>
            <span class="n">current</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ok_state</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">on_mqtt_connected</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-2: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="n">ok_state</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-3: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">return</span>     

</pre></div>
</div>
</section>
<section id="voorbeelden">
<h2>Voorbeelden<a class="headerlink" href="#voorbeelden" title="Permalink naar deze titel">#</a></h2>
<ul class="simple">
<li><p>zie <a class="reference external" href="https://docs.espressif.com/projects/esp-at/en/release-v2.1.0.0_esp8266/AT_Command_Examples/MQTT_AT_Examples.html">https://docs.espressif.com/projects/esp-at/en/release-v2.1.0.0_esp8266/AT_Command_Examples/MQTT_AT_Examples.html</a></p></li>
</ul>
<p>NB: er zijn veel opdrachten die alleen OK als resultaat hebben, of een foutcode. Daarvoor kunnen we waarschijnlijk een algemeen stramien ontwerpen.</p>
<section id="voorbereidden-van-de-mqtt-connect">
<h3>Voorbereidden van de MQTT connect<a class="headerlink" href="#voorbereidden-van-de-mqtt-connect" title="Permalink naar deze titel">#</a></h3>
<p>Voordat we de Connect opdracht kunnen geven, moeten we eerst de configuratie instellen.</p>
<ul class="simple">
<li></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AT</span><span class="o">+</span><span class="n">MQTTUSERCFG</span><span class="o">=&lt;</span><span class="n">LinkID</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">scheme</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="s2">&quot;client_id&quot;</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="s2">&quot;username&quot;</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="s2">&quot;password&quot;</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">cert_key_ID</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">CA_ID</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="s2">&quot;path&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>linkID = 0</p></li>
<li><p>scheme = 1 (MQTT over TCP)</p></li>
<li><p>client_id = (een unieke string - gebaseerd op MAC adres?)</p></li>
<li><p>username = “mqtttest”</p></li>
<li><p>password = “testmqtt”</p></li>
<li><p>cert = , (of weglaten…)</p></li>
<li><p>CA_ID = ,</p></li>
<li><p>path = ,</p></li>
</ul>
<blockquote>
<div><p>The total length of the entire AT command should be less than 256Bytes.</p>
</div></blockquote>
<p>NB: als er meerdere clients zijn die zich aanmelden met dezelfde client_id, dan blijft alleen de laatste actief. De verbinding met de anderen wordt dan verbroken. Je moet dus wel zorgen dat die id uniek is, maar de waarde zelf doet er verder niet zoveel toe.</p>
<p>Je kunt het MAC-adres opvragen met: <a class="reference external" href="https://docs.espressif.com/projects/esp-at/en/release-v2.1.0.0_esp8266/AT_Command_Set/Wi-Fi_AT_Commands.html#cmd-STAMAC">https://docs.espressif.com/projects/esp-at/en/release-v2.1.0.0_esp8266/AT_Command_Set/Wi-Fi_AT_Commands.html#cmd-STAMAC</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>AT+CIPSTAMAC?
Function: to obtain the MAC address of the ESP32 Station.
Response:
+CIPSTAMAC:&lt;mac&gt;
OK
</pre></div>
</div>
<p>Je kunt het IP-adres opvragen met:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>AT+CIPSTA?
Function: to obtain the IP address of the ESP32 Station.
Notice: Only when the ESP32 Station is connected to an AP can its IP address be queried.
Response:
+CIPSTA:&lt;ip&gt;
OK
</pre></div>
</div>
</section>
</section>
<section id="at-messages">
<h2>AT messages<a class="headerlink" href="#at-messages" title="Permalink naar deze titel">#</a></h2>
<p>De <em>messages</em> zijn unsollicited?</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.espressif.com/projects/esp-at/en/release-v2.1.0.0_esp8266/AT_Command_Set/index.html">https://docs.espressif.com/projects/esp-at/en/release-v2.1.0.0_esp8266/AT_Command_Set/index.html</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;aap&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;noot&quot;</span><span class="p">:</span> <span class="s2">&quot;pinda&quot;</span><span class="p">,</span> <span class="s2">&quot;mies&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">[</span><span class="s2">&quot;aap&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">last_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">mac_address</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;echo&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;complete&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">set_current</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">current</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">txt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    
<span class="c1"># form of command: AT+cmd=arg0,arg1,arg2,arg3</span>

<span class="k">def</span> <span class="nf">sendAT</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="c1"># remove AT+ part</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span> <span class="c1"># remove = part</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span> <span class="c1"># remove ? part</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;..&quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>        
    <span class="n">set_current</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>  
    <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{cmd}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">command</span><span class="p">))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="c1"># basic.pause(wait)</span>

<span class="n">ok_state</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">ip_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">mac_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">netmask</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span> <span class="nf">on_wifi_connected</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTAMAC?&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_mqtt_connected</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">on_mac_address_complete</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTA?&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">on_ip_address_complete</span><span class="p">():</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;ip address complete&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">ok_state</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">wifi_connected</span><span class="p">,</span> <span class="n">mqtt_connected</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">ip_address</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span>

    <span class="c1"># first, handle unsollicited messages</span>

    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MQTTSUBRECV&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI CONNECTED&#39;</span><span class="p">):</span>
        <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI GOT IP&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># next,  handle complex (or all?) commands</span>

    <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CWJAP&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&#39;</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CWJAP:&#39;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ok_state</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
            <span class="n">ok_state</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">wifi_connected</span><span class="p">:</span>
                <span class="n">on_wifi_connected</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-1: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CIPSTAMAC&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;AT+CIPSTAMAC&quot;</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTAMAC:&quot;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">mac_address</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mac-addr:&quot;</span> <span class="o">+</span> <span class="n">mac_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
            <span class="n">on_mac_address_complete</span><span class="p">()</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CIPSTA&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;AT+CIPSTA&quot;</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:ip:&quot;</span><span class="p">):</span>
            <span class="n">ip_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;ip-addr:&quot;</span> <span class="o">+</span> <span class="n">ip_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:gateway:&quot;</span><span class="p">):</span>
            <span class="n">gateway_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;gateway-addr:&quot;</span> <span class="o">+</span> <span class="n">gateway_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:netmask:&quot;</span><span class="p">):</span>
            <span class="n">netmask</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;netmask:&quot;</span> <span class="o">+</span> <span class="n">netmask</span><span class="p">)</span>
            <span class="k">return</span>         
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
            <span class="n">on_ip_address_complete</span><span class="p">()</span>
            <span class="k">return</span>    
    
    <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MQTTCONN&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AT+MQTTCONN=&#39;</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-2: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AT+&#39;</span> <span class="o">+</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]):</span>
            <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
        <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ok_state</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
        <span class="n">current</span><span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ok_state</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span>
    
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-3: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">init_ESP8266</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RESTORE&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># restore to factory settings</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>     <span class="c1"># reset, restart</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">buf</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWMODE=1&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="c1"># set to STA mode    </span>

<span class="k">def</span> <span class="nf">init_WiFi</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&quot;</span><span class="si">{ssid}</span><span class="s1">&quot;,&quot;</span><span class="si">{pw}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ssid</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">),</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;...connected??&quot;</span><span class="p">)</span>

<span class="n">radio</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        
    <span class="k">if</span> <span class="n">button_a</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;A pressed&quot;</span><span class="p">)</span>
        <span class="n">uart</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">pin8</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">pin12</span><span class="p">)</span> <span class="c1"># connect to ESP8266</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">init_ESP8266</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">button_b</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;B pressed&quot;</span><span class="p">)</span>
        <span class="n">init_WiFi</span><span class="p">()</span>
          
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">in_bytes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_buffer</span> <span class="o">+=</span> <span class="n">in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="c1"># radio.send(&#39;-&gt;&#39; + input_buffer + &#39;&lt;-\r\n&#39;)</span>

    <span class="n">eol_pos</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eol_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eol_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># get line and</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove from input_buffer</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Wachten tot de OK of ERROR response, ten teken dat een opdracht afgerond is, en de ESP8266 klaar is voor de volgende opdracht:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_at</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">input_buffer</span>
    
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">in_bytes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_buffer</span> <span class="o">+=</span> <span class="n">in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="c1"># radio.send(&#39;-&gt;&#39; + input_buffer + &#39;&lt;-\r\n&#39;)</span>

    <span class="n">eol_pos</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eol_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eol_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># get line and</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove from input_buffer</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            
<span class="k">def</span> <span class="nf">wait_at_completed</span><span class="p">():</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="n">at_ok</span> <span class="ow">or</span> <span class="n">at_error</span><span class="p">):</span>
        <span class="n">check_wifi</span><span class="p">()</span>
</pre></div>
</div>
<p>We hebben nu o.a. de variabelen <code class="docutils literal notranslate"><span class="pre">ok_state</span></code> en <code class="docutils literal notranslate"><span class="pre">error_state</span></code>, hernoemen tot <code class="docutils literal notranslate"><span class="pre">at_ok</span></code> en <code class="docutils literal notranslate"><span class="pre">at_error</span></code>.</p>
<p>Volgt er in het geval van een query ook een OK? - Ja, zo te zien aan de log van zowel CIPSTA als CIPSTAMAC.</p>
<p>NB: eigenlijk moeten we niet alleen de naam, maar ook de <code class="docutils literal notranslate"><span class="pre">=</span></code> of <code class="docutils literal notranslate"><span class="pre">?</span></code> meenemen als onderdeel van het AT-commando, bij de verwerking in de <code class="docutils literal notranslate"><span class="pre">handle_inputline</span></code>. (Eigenlijk: <code class="docutils literal notranslate"><span class="pre">at_handle_line</span></code>? of <code class="docutils literal notranslate"><span class="pre">handle_at_line</span></code>?)
Immers, de response die we verwachten hangt ook af van het type commando.</p>
<p>De OK en ERROR exits zijn voor veel opdrachten gemeenschappelijk. Het verschil is dat in sommige gevallen bij OK een speciale on-functie aangeroepen wordt.</p>
<p><strong>Exceptions.</strong> Eén van de manieren om fouten te signaleren in Python, is het gebruik van exceptions. Levert dat in onze voorbeelden voordelen op?</p>
<p>Welke functies willen we definiëren - in de context van de gateway, maar mogelijk ook andere Python netwerk-toepassingen?</p>
<ul class="simple">
<li><p>initialiseren van de module (reset)</p></li>
<li><p>opzetten van de WiFi-verbinding</p></li>
<li><p>opvragen van het MAC-adres</p></li>
<li><p>opvragen van het IP-adres (heeft alleen zin als er een IP-verbinding is)</p></li>
<li><p>opzetten van de MQTT-verbinding</p></li>
<li><p>abonneren op een MQTT topic</p></li>
</ul>
<p><strong>Opmerking</strong>. Tijdens het opzetten van de verbindingen van de gateway doen de andere inputs er niet toe: je kunt de invoer daarvan toch niet verwerken.</p>
<p><strong>NB</strong> De wachttijd kan in het geval van expliciet wachten op OK of ERROR volgens mij gewoon 0 zijn. Maar daar moeten we dan wel mee experimenteren.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">at_wifi_connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&quot;</span><span class="si">{ssid}</span><span class="s1">&quot;,&quot;</span><span class="si">{pw}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ssid</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">),</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">wait_at</span><span class="o">+</span><span class="n">completed</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">at_ok</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wifi_connected</span><span class="p">:</span>
            <span class="n">on_wifi_connected</span><span class="p">()</span>
        <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTAMAC?&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">wait_at_completed</span><span class="p">()</span>
        <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTA?&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">wait_at_completed</span><span class="p">()</span>     
</pre></div>
</div>
</div>
</div>
<p><strong>Foutsignalering</strong> Bijvoorbeeld bij het opbouwen van een WiFi-verbinding: CWJAP.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;+</span><span class="n">CWJAP</span><span class="p">:</span><span class="mi">4</span><span class="o">&lt;&lt;</span>
<span class="o">&gt;&gt;&lt;&lt;</span>
<span class="o">&gt;&gt;</span><span class="n">ERROR</span><span class="o">&lt;&lt;</span>
</pre></div>
</div>
<p>Je krijgt dan eerst de foutcode, en daarna “ERROR”. De invoer <code class="docutils literal notranslate"><span class="pre">+CWJAP:xx</span></code> komt alleen in het geval van een fout, niet bij correcte verwerking. (4 staat voor: connection failed; daar word je natuurlijk veel wijzer van…)</p>
<p>Hoe worden de verschillende vormen genoemd?</p>
<ul class="simple">
<li><p>Test (<code class="docutils literal notranslate"><span class="pre">=?</span></code>) - <em>voorbeeld???</em></p></li>
<li><p>Query (<code class="docutils literal notranslate"><span class="pre">?</span></code>) -</p></li>
<li><p>Set (<code class="docutils literal notranslate"><span class="pre">=</span></code>)</p></li>
<li><p>Execute (``)</p></li>
</ul>
<p>Eigenlijk horen die tekens bij het commando - omdat de response ook afhangt van de vorm.</p>
<p>NB: ik begrijp dat ERROR ook unsollicited kan voorkomen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">at_mqtt_set_userconfig</span><span class="p">(</span><span class="n">scheme</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">;</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTUSERCFG=1,</span><span class="si">{a}</span><span class="s1">,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,&quot;</span><span class="si">{c}</span><span class="s1">&quot;,&quot;</span><span class="si">{d}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">scheme</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">client_id</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">password</span>
    <span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Wij gebruiken voorlopig alleen scheme: 1, mqtt over TCP</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">at_mqtt_connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">reconnect</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTCONN=1,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">host</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">port</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">reconnect</span>
    <span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Wat zijn de AT-opdrachten waarmee er een complexere interactie is?</p>
<ul class="simple">
<li><p>de queries: hierbij wordt er altijd een response gegeven. (De vorm daarvan is overigens goed af te leiden van de opdracht.)</p></li>
</ul>
<p>Ik heb in het voorgaande een speciale vorm voor MQTTCONN opgenomen, maar volgens mij is dat eigenlijk niet nodig: deze valt onder de generieke vorm van OK (en ERROR?).</p>
<ul class="simple">
<li><p>wordt er in het geval van een fout, mislukte verbinding, ook een foutcode gegeven?</p></li>
<li><p>hierover staat niets gedocumenteerd, maar ik kan mij dat niet voorstellen…</p></li>
<li><p>ik zou ongeveer dezelfde foutcodes verwachten als in het geval van de WiFi connectie.</p></li>
</ul>
<p>Hieronder volgt een volgende versie van de gateway code, nu met “wait_at_completed”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="n">wifi_ssid</span> <span class="o">=</span> <span class="s1">&#39;xxx&#39;</span>
<span class="n">wifi_password</span> <span class="o">=</span> <span class="s1">&#39;xxx&#39;</span>

<span class="n">last_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;echo&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<span class="n">at_ok</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">at_error</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">at_errorcode</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">set_current</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">current</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">txt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    
<span class="c1"># form of command: AT+cmd=arg0,arg1,arg2,arg3</span>

<span class="k">def</span> <span class="nf">sendAT</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_ok</span><span class="p">,</span> <span class="n">at_error</span><span class="p">,</span> <span class="n">at_errorcode</span>
    <span class="n">at_ok</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">at_error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">at_errorcode</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="c1"># remove AT+ part</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span> <span class="c1"># remove = part</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span> <span class="c1"># remove ? part</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;..&quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>        
    <span class="n">set_current</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>  
    <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{cmd}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">command</span><span class="p">))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="c1"># basic.pause(wait)</span>

<span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">ip_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">mac_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">netmask</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span> <span class="nf">on_wifi_connected</span><span class="p">():</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;on wifi connected&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_mqtt_connected</span><span class="p">():</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;on mqtt connected&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_ok</span><span class="p">,</span> <span class="n">at_error</span><span class="p">,</span> <span class="n">at_errorcode</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">gateway_address</span><span class="p">,</span> <span class="n">netmask</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span>

    <span class="c1"># first, handle unsollicited messages</span>

    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MQTTSUBRECV&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI CONNECTED&#39;</span><span class="p">):</span>
        <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI GOT IP&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># next,  handle complex (or all?) commands</span>

    <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CWJAP&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CWJAP:&#39;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="n">at_errorcode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CIPSTAMAC&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTAMAC:&quot;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">mac_address</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mac-addr:&quot;</span> <span class="o">+</span> <span class="n">mac_address</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CIPSTA&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:ip:&quot;</span><span class="p">):</span>
            <span class="n">ip_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;ip-addr:&quot;</span> <span class="o">+</span> <span class="n">ip_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:gateway:&quot;</span><span class="p">):</span>
            <span class="n">gateway_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;gateway-addr:&quot;</span> <span class="o">+</span> <span class="n">gateway_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:netmask:&quot;</span><span class="p">):</span>
            <span class="n">netmask</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;netmask:&quot;</span> <span class="o">+</span> <span class="n">netmask</span><span class="p">)</span>
            <span class="k">return</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
  
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AT+&#39;</span> <span class="o">+</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]):</span>
        <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
        <span class="n">at_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
        <span class="n">at_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-3: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">init_ESP8266</span><span class="p">():</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RESTORE&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># restore to factory settings</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>     <span class="c1"># reset, restart</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">buf</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWMODE=1&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="c1"># set to STA mode</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
    <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
    
<span class="c1"># the delay for sendAT is set to 0: wait_at_completed takes case of timing</span>
    
<span class="k">def</span> <span class="nf">at_wifi_connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">ssid</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">password</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">at_ok</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wifi_connected</span><span class="p">:</span>
            <span class="n">on_wifi_connected</span><span class="p">()</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTAMAC?&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_at_completed</span><span class="p">()</span>
        <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTA?&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_at_completed</span><span class="p">()</span>    

<span class="n">radio</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>

<span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">at_check_input</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">input_buffer</span>
    
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">in_bytes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_buffer</span> <span class="o">+=</span> <span class="n">in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="n">eol_pos</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eol_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eol_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># get line and</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove from input_buffer</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">wait_at_completed</span><span class="p">():</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="n">at_ok</span> <span class="ow">or</span> <span class="n">at_error</span><span class="p">):</span>
        <span class="n">at_check_input</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>      
    <span class="k">if</span> <span class="n">button_a</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;A pressed&quot;</span><span class="p">)</span>
        <span class="n">uart</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">pin8</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">pin12</span><span class="p">)</span> <span class="c1"># connect to ESP8266</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">init_ESP8266</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">button_b</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;B pressed&quot;</span><span class="p">)</span>
        <span class="n">at_wifi_connect</span><span class="p">(</span><span class="n">wifi_ssid</span><span class="p">,</span> <span class="n">wifi_password</span><span class="p">)</span>
          
    <span class="n">at_check_input</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>het heeft eigenlijk geen zin om de echo-gegevens bij te houden. Eventueel kunnen we een globale boolean “at_echo” bijhouden?</p></li>
<li><p>de manier waarop we de huidige opdracht vastleggen kunnen we verbeteren:</p>
<ul>
<li><p><em>inclusief</em> de <code class="docutils literal notranslate"><span class="pre">=</span></code> of <code class="docutils literal notranslate"><span class="pre">?</span></code>.</p></li>
<li><p>expliciet meegeven als afzonderlijke onderdelen, in plaats van decoderen uit de complete opdracht?</p></li>
</ul>
</li>
<li><p>de knoppen kunnen we voor verschillende functies gebruiken, afhankelijk van de toestand</p>
<ul>
<li><p>knop B: als er nog geen wifi verbinding is: maak wifi verbinding</p></li>
<li><p>knop B: als er al een wifi verbinding is (en geen mqtt): maak mqtt verbinding</p></li>
<li><p>knop B: als er een mqtt verbinding is: stuur mqtt bericht.</p></li>
<li><p>elk van deze deelopdrachten eindigt met <code class="docutils literal notranslate"><span class="pre">wait_at_completed()</span></code>.</p></li>
</ul>
</li>
</ul>
<p>In de bovenstaande code maak ik nogal eens gebruik van de (constance) positie van een scheidingsteken, zoals een <code class="docutils literal notranslate"><span class="pre">:</span></code>. We kunnen beter een functie maken die de rest van de string na een scheidingsteken oplevert.</p>
</section>
<section id="mqtt">
<h2>MQTT<a class="headerlink" href="#mqtt" title="Permalink naar deze titel">#</a></h2>
<ul class="simple">
<li><p>configureren van MQTT gebruiker (username, password)</p></li>
<li><p>verbinding maken met MQTT</p></li>
<li><p>publiceren van een bericht via MQTT</p></li>
<li><p>abonneren op MQTT topics</p></li>
<li><p>ontvangen van MQTT berichten</p></li>
</ul>
<p>NB: miscchien kunnen we de client-id hierin weglaten, en alvast een client-id afgeleid van het MAC-adres invullen. (Een client-id is max. 23 bytes lang. Het MAC-adres is 12 (hex) tekens lang. Bijvoorbeeld: “gw-” gevolgd door het mac-adres?)</p>
<p>Het schema is (voorlopig) alleen 1: MQTT over TCP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">at_mqtt_set_userconfig</span><span class="p">(</span><span class="n">scheme</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">;</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTUSERCFG=0,</span><span class="si">{a}</span><span class="s1">,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,&quot;</span><span class="si">{c}</span><span class="s1">&quot;,&quot;</span><span class="si">{d}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">scheme</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">client_id</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">password</span>
    <span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">at_mqtt_connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">reconnect</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTCONN=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">host</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">port</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">reconnect</span>
    <span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="n">wifi_ssid</span> <span class="o">=</span> <span class="s1">&#39;xxx&#39;</span>
<span class="n">wifi_password</span> <span class="o">=</span> <span class="s1">&#39;xxx&#39;</span>
<span class="n">mqtt_user</span> <span class="o">=</span> <span class="s1">&#39;mqtttest&#39;</span>
<span class="n">mqtt_password</span> <span class="o">=</span> <span class="s1">&#39;testmqtt&#39;</span>
<span class="n">mqtt_host</span> <span class="o">=</span> <span class="s1">&#39;infvopedia.nl&#39;</span>
<span class="n">mqtt_port</span> <span class="o">=</span> <span class="mi">1883</span>
<span class="n">mqtt_tcp</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">last_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;echo&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<span class="n">at_ok</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">at_error</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">at_errorcode</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">set_current</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">current</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>
    <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">txt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    
<span class="c1"># form of command: AT+cmd=arg0,arg1,arg2,arg3</span>

<span class="k">def</span> <span class="nf">sendAT</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_ok</span><span class="p">,</span> <span class="n">at_error</span><span class="p">,</span> <span class="n">at_errorcode</span>
    <span class="n">at_ok</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">at_error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">at_errorcode</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="c1"># remove AT+ part</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span> <span class="c1"># remove = part</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span> <span class="c1"># remove ? part</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;..&quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>        
    <span class="n">set_current</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>  
    <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{a}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">command</span><span class="p">))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="c1"># basic.pause(wait)</span>

<span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">ip_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">mac_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">netmask</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span> <span class="nf">on_wifi_connected</span><span class="p">():</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;on wifi connected&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_mqtt_connected</span><span class="p">():</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;on mqtt connected&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_ok</span><span class="p">,</span> <span class="n">at_error</span><span class="p">,</span> <span class="n">at_errorcode</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">wifi_connected</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">gateway_address</span><span class="p">,</span> <span class="n">netmask</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span>

    <span class="c1"># first, handle unsollicited messages</span>

    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI CONNECTED&#39;</span><span class="p">):</span>
        <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI GOT IP&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># next,  handle complex (or all?) commands</span>

    <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CWJAP&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CWJAP:&#39;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="n">at_errorcode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CIPSTAMAC&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTAMAC:&quot;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">mac_address</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mac-addr:&quot;</span> <span class="o">+</span> <span class="n">mac_address</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CIPSTA&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:ip:&quot;</span><span class="p">):</span>
            <span class="n">ip_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;ip-addr:&quot;</span> <span class="o">+</span> <span class="n">ip_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:gateway:&quot;</span><span class="p">):</span>
            <span class="n">gateway_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;gateway-addr:&quot;</span> <span class="o">+</span> <span class="n">gateway_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:netmask:&quot;</span><span class="p">):</span>
            <span class="n">netmask</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;netmask:&quot;</span> <span class="o">+</span> <span class="n">netmask</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MQTTCONN&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+MQTTCONNECTED:&quot;</span><span class="p">):</span>  <span class="c1"># kan ook unsollicited...</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mqtt connected&quot;</span><span class="p">)</span>
            <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
  
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AT+&#39;</span> <span class="o">+</span> <span class="n">current</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]):</span>
        <span class="n">current</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
        <span class="n">at_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
        <span class="n">at_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-3: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">init_ESP8266</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">wifi_connected</span><span class="p">,</span> <span class="n">mqtt_connected</span>
    <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RESTORE&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># restore to factory settings</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>     <span class="c1"># reset, restart</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">buf</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWMODE=1&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="c1"># set to STA mode</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
    <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
    
<span class="c1"># the delay for sendAT is set to 0: wait_at_completed takes care of timing</span>
    
<span class="k">def</span> <span class="nf">at_wifi_connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">ssid</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">password</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">at_ok</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wifi_connected</span><span class="p">:</span>
            <span class="n">on_wifi_connected</span><span class="p">()</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTAMAC?&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_at_completed</span><span class="p">()</span>
        <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTA?&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_at_completed</span><span class="p">()</span>
        
<span class="k">def</span> <span class="nf">at_mqtt_set_userconfig</span><span class="p">(</span><span class="n">scheme</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTUSERCFG=0,</span><span class="si">{a}</span><span class="s1">,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,&quot;</span><span class="si">{c}</span><span class="s1">&quot;,&quot;</span><span class="si">{d}</span><span class="s1">&quot;,0,0,&quot;&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">scheme</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">client_id</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">password</span>
    <span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>
    
<span class="k">def</span> <span class="nf">at_mqtt_connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">reconnect</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTCONN=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,</span><span class="si">{b}</span><span class="s1">,</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">host</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">port</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">reconnect</span>
    <span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">wait_at_completed</span><span class="p">()</span>    
        
<span class="k">def</span> <span class="nf">at_mqtt_start</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">mqtt_connected</span>
    
    <span class="n">at_mqtt_set_userconfig</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;gw-&#39;</span><span class="o">+</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">mqtt_user</span><span class="p">,</span> <span class="n">mqtt_password</span><span class="p">)</span>
    <span class="n">at_mqtt_connect</span><span class="p">(</span><span class="n">mqtt_host</span><span class="p">,</span> <span class="n">mqtt_port</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">at_ok</span><span class="p">:</span>
        <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
        <span class="n">on_mqtt_connected</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">at_mqtt_publish</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">retain</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTPUB=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,</span><span class="si">{c}</span><span class="s1">,</span><span class="si">{d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">topic</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">qos</span><span class="p">,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">retain</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">))</span>
    
<span class="k">def</span> <span class="nf">at_mqtt_subscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qos</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+MQTTSUB=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,</span><span class="si">{b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">topic</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">qos</span>
    <span class="p">))</span>
    
<span class="k">def</span> <span class="nf">on_mqtt_message</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;msg-topic: &#39;</span> <span class="o">+</span> <span class="n">topic</span><span class="p">)</span>
    <span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
<span class="n">radio</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>

<span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">at_check_input</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">input_buffer</span>
    
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">in_bytes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_buffer</span> <span class="o">+=</span> <span class="n">in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+MQTTSUBRECV:0&#39;</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span> 
            <span class="k">return</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="n">datasize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mqtt-datasize: &quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">datasize</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># incl. CRLF</span>
            <span class="k">return</span>
        <span class="n">totalsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">datasize</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="c1"># 3 comma&#39;s and CRLF</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">totalsize</span><span class="p">:]</span>
        <span class="n">on_mqtt_message</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">datasize</span><span class="p">])</span>
        <span class="k">return</span>
        
    <span class="n">eol_pos</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eol_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eol_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># get line and</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove from input_buffer</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">wait_at_completed</span><span class="p">():</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="n">at_ok</span> <span class="ow">or</span> <span class="n">at_error</span><span class="p">):</span>
        <span class="n">at_check_input</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>      
    <span class="k">if</span> <span class="n">button_a</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;A pressed&quot;</span><span class="p">)</span>
        <span class="n">uart</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">pin8</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">pin12</span><span class="p">)</span> <span class="c1"># connect to ESP8266</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">init_ESP8266</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">button_b</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;B pressed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wifi_connected</span><span class="p">:</span>
            <span class="n">at_wifi_connect</span><span class="p">(</span><span class="n">wifi_ssid</span><span class="p">,</span> <span class="n">wifi_password</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">mqtt_connected</span><span class="p">:</span>
            <span class="n">at_mqtt_start</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">mqtt_connected</span><span class="p">:</span>
            <span class="n">at_mqtt_publish</span><span class="p">(</span><span class="s2">&quot;microbit/test&quot;</span><span class="p">,</span> <span class="s2">&quot;Succes!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">wait_at_completed</span><span class="p">()</span>
            <span class="n">at_mqtt_subscribe</span><span class="p">(</span><span class="s2">&quot;microbit/test&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">wait_at_completed</span><span class="p">()</span>
          
    <span class="n">at_check_input</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Het bovenstaande werkt! (22-4-2023, 17:30). De berichten worden door de broker (en de andere clients) netjes ontvangen.</p>
<p>(De subscribe is 23 april toegevoegd, en werkte ook (bijna) direct goed: het afhandelen van de inkomende data die over meerdere regels verdeeld is, gaat nog niet goed.)</p>
<p>We weten dat de LFs niet doorgegeven worden; maar het teken daarvoor zou wel doorgegeven moeten worden (ook als het een CR is???) - we moeten mogelijk een andere strategie gebruiken.</p>
<p>De volgende stappen zijn:</p>
<ul class="simple">
<li><p>ontvangen van mqtt-berichten</p></li>
<li><p>integreren met de gateway-code (zoals al eerder gemaakt, voor de ESP32 gateway).</p></li>
</ul>
<p>De structuur van de ontvangen mqtt-berichten wijkt wat af van de normale structuur.</p>
<p>Mogelijke aanpak:</p>
<ul class="simple">
<li><p>bij de aanroep van <code class="docutils literal notranslate"><span class="pre">handle_input_line</span></code> geven we de regel inclusief de (CR)LF door. Deze maken mogelijk deel uit van de data, deze kunnen we (nog) niet verwijderen.</p></li>
<li><p>in <code class="docutils literal notranslate"><span class="pre">handle_input_line</span></code> controleren we als eerste op een inkomend mqtt-bericht. Het kan zijn dat dit nog niet compleet is: we moeten dan rest van het bericht inlezen. (…eigenlijk kan dat niet met behulp van uart-opdrachten die niet het complete bericht opleveren; we willen geen blokkerende acties.)</p>
<ul>
<li><p>om het goed te doen, moeten we (asynchroon) de uart-leesopdrachten geven totdat het bericht compleet is. Dat kan eigenlijk niet in handle_input-line, maar moet dan in de at_check_input-functie.</p></li>
</ul>
</li>
</ul>
<p>(27-april 17:00) Het (afzonderlijk) ontvangen van berichten <strong>lijkt nu goed te werken</strong>; de max. grootte die ontvangen wordt is 128? - (klopt de lengte dan wel? en, als de lengte niet klopt, wordt er dan ook teveel data uit de invoerbuffer gelezen?)</p>
<p>Met andere woorden: ik moet bij het verwerken van de invoerdata van een bericht rekening houden met deze lengte-problemen.</p>
<p>Het wordt ook tijd om van de test-structuur af te stappen, en een meer definitieve opzet van het programma te maken.</p>
<p>Waar ik nog niet uit ben: gebruiken we daarvoor een aparte library? En moeten we die ook kunnen gebruiken voor de microbit als iot-device (in plaats van de implementatie als gateway)?</p>
<p>Er verschijnt zo nu en dan ook een bericht dat de mqtt-verbinding verbroken is. (En, omdat de instelling zo is dat die verbinding automatisch hersteld wordt, ook een bericht dat de verbinding weer werkt.)</p>
<p>(Kunnen hierdoor berichten verloren gaan? We moeten dan weer berichten gaan nummeren…)</p>
</section>
<section id="organiseren-als-library">
<h2>Organiseren als library<a class="headerlink" href="#organiseren-als-library" title="Permalink naar deze titel">#</a></h2>
<p>Kunnen we e.e.a. organiseren als library, die we kunnen gebruiken (i) voor een microbit als IoT-device; (ii) voor een microbit als IoT-gateway?</p>
<p>Sommige van deze functies zijn synchroon, d.w.z., pas als de opdracht succesvol uitgevoerd is, keert de functie terug.</p>
<p>Andere functies keren direct terug; maar er kan pas een volgende opdracht gegeven worden, als de vorige afgerond is.
Omdat het geen zin heeft lokale functies uit te voeren als er nog geen verbinding is (in elk geval voor een gateway), zijn sommige van deze functies synchroon: ze wachten tot ze klaar zijn.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">at_busy</span></code> geeft aan dat er nog een functie bezig is uitgevoerd te worden. Er kan dan geen nieuwe functie uitgevoerd worden.</p></li>
<li><p>de functie <code class="docutils literal notranslate"><span class="pre">at_check_input()</span></code> moet in de event-loop uitgevoerd worden. Als deze functie niet vaak genoeg aangeroepen wordt, loop je de kans om inputs van de module te missen.</p></li>
</ul>
<p>Mogelijke functies:</p>
<ul class="simple">
<li><p>at_init (of reset) (+)</p></li>
<li><p>at_wifi_connect (+)</p></li>
<li><p>at_mqtt_configure (+)</p></li>
<li><p>at_mqtt_connect (*)</p></li>
<li><p>at_mqtt_is_connected (+)</p></li>
<li><p>at_busy (of at_is_completed?)</p></li>
<li><p>at_mqtt_subscribe</p></li>
<li><p>at_mqtt_on_message (of subscribed message)</p></li>
<li><p>at_mqtt_publish (*)</p></li>
<li><p>at_wait_completed (+)</p></li>
<li><p>at_check_input (**)</p></li>
</ul>
<p>Er kan van alles misgaan bij het uitvoeren van een functie. Het resultaat is pas bekend als de functie uitgevoerd is. (Soms is er dan ook een foutcode beschikbaar.)</p>
<p>Een “asynchrone” functie kan in een synchrone omgezet worden door deze te laten volgen door:</p>
<p><code class="docutils literal notranslate"><span class="pre">at_wait_completed()</span></code> (NB: deze functie is een vorm van “actief wachten”: de input moet voortdurend gecontroleerd worden.)</p>
<p>(Heeft het dan wel zin om de synchrone varianten aan te bieden? De gebruiker kan die altijd zelf maken?)</p>
<p>(als je een functie aanroept terwijl de vorige nog actief is, wordt deze direct beëindigd?) Of: dan wordt gewacht tot de vorige functie klaar is - we draaien de synchronsatie dan eigenlijk om…</p>
<p>Een probleem is dat je de fouten dan mogelijk op de verkeerde plek signaleert, nl. bij de volgende functie.</p>
<p>We kunnen ook afspreken dat in het geval van een fout in de vorige functie, de volgende functie in een exception resulteert.
De meeste functies bij de initialisatie zijn afhankelijk van het succes van de voorafgaande functie(s).
Door het gebruik van exceptions hoeven we niet steeds op die mogelijke fouten te controleren.</p>
<p>Er zijn nu twee manieren om na te gaan of er een opdracht actief is:</p>
<ul class="simple">
<li><p>als zowel ok als error False zijn</p></li>
<li><p>als de huidige opdracht niet leeg is.</p></li>
</ul>
<p><strong>Gebruik van display: in de toepassing, niet in de library.</strong> Voor de toepassing is het handig als je als gebruiker de status weet, bijvoorbeeld: verbonden met het WiFi netwerk, of verbonden met de MQTT broker.
In de context van de iot:bit heb je daarvoor eigenlijk alleen het display beschikbaar.</p>
<p>Het is niet handig om het display te gebruiken (claimen) vanuit een libraryfunctie. Dit moeten we dus verhuizen naar de toepassing.</p>
</section>
<section id="atesp-library">
<h2>atesp library<a class="headerlink" href="#atesp-library" title="Permalink naar deze titel">#</a></h2>
<p>(Ik vind de naam nog niet goed gekozen, deze is niet afhankelijk van ESP. Maar het is wel de ESP code en documentatie die we gebruiken als uitgangspunt.)</p>
<p><strong>Opmerkingen.</strong></p>
<ul class="simple">
<li><p>we slaan de volledige at-opdracht op, zonder de parameters, maar inclusief <code class="docutils literal notranslate"><span class="pre">AT+</span></code> en <code class="docutils literal notranslate"><span class="pre">=</span></code> of <code class="docutils literal notranslate"><span class="pre">?</span></code>. (Ik weet niet waarom niet…)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="c1"># global variables</span>

<span class="n">at_ok</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">at_error</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">at_errorcode</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">at_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">ip_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">mac_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">netmask</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="c1"># logging to remote microbit</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">txt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

<span class="n">radio</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>

<span class="c1"># low-level: send command to ESP module</span>

<span class="k">def</span> <span class="nf">sendAT</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{a}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">command</span><span class="p">))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_cmd</span><span class="p">,</span> <span class="n">at_ok</span><span class="p">,</span> <span class="n">at_error</span><span class="p">,</span> <span class="n">at_errorcode</span><span class="p">,</span> <span class="n">wifi_connected</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">gateway_address</span><span class="p">,</span> <span class="n">netmask</span>
    <span class="k">global</span> <span class="n">mqtt_connected</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span>

    <span class="c1"># first, handle unsollicited messages</span>

    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI CONNECTED&#39;</span><span class="p">):</span>
        <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI GOT IP&#39;</span><span class="p">):</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+MQTTCONNECTED:&quot;</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mqtt connected&quot;</span><span class="p">)</span>
        <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+MQTTDISCONNECTED:&quot;</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mqtt disconnected&quot;</span><span class="p">)</span>
        <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
        <span class="k">return</span> 

    <span class="c1"># next,  handle complex (or all?) commands</span>

    <span class="k">if</span> <span class="n">at_cmd</span> <span class="o">==</span> <span class="s1">&#39;AT+CWJAP=&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CWJAP:&#39;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="n">at_errorcode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">at_cmd</span> <span class="o">==</span> <span class="s2">&quot;AT+CIPSTAMAC?&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTAMAC:&quot;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">mac_address</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mac-addr:&quot;</span> <span class="o">+</span> <span class="n">mac_address</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">at_cmd</span> <span class="o">==</span> <span class="s2">&quot;AT+CIPSTA?&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:ip:&quot;</span><span class="p">):</span>
            <span class="n">ip_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;ip-addr:&quot;</span> <span class="o">+</span> <span class="n">ip_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:gateway:&quot;</span><span class="p">):</span>
            <span class="n">gateway_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;gateway-addr:&quot;</span> <span class="o">+</span> <span class="n">gateway_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:netmask:&quot;</span><span class="p">):</span>
            <span class="n">netmask</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;netmask:&quot;</span> <span class="o">+</span> <span class="n">netmask</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
  
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">at_cmd</span><span class="p">):</span>
        <span class="c1"># echo</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
        <span class="n">at_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">at_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
        <span class="n">at_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">at_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span>
    
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-3: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">log_mqtt_message</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;msg-topic: &#39;</span> <span class="o">+</span> <span class="n">topic</span><span class="p">)</span>
    <span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
<span class="n">on_mqtt_message</span> <span class="o">=</span> <span class="n">log_mqtt_message</span>

<span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">at_check_input</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">input_buffer</span>
    
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">in_bytes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_buffer</span> <span class="o">+=</span> <span class="n">in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+MQTTSUBRECV:0&#39;</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span> 
            <span class="k">return</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="n">datasize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mqtt-datasize: &quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">datasize</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># incl. CRLF</span>
            <span class="k">return</span>
        <span class="n">totalsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">datasize</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="c1"># 3 comma&#39;s and CRLF</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">totalsize</span><span class="p">:]</span>
        <span class="n">on_mqtt_message</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">datasize</span><span class="p">])</span>
        <span class="k">return</span>
        
    <span class="n">eol_pos</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eol_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eol_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># get line and</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove from input_buffer</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="c1"># wait until last at-command is finished (OR or ERROR)</span>
<span class="k">def</span> <span class="nf">wait_at_ready</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">at_cmd</span>
    <span class="k">while</span> <span class="n">at_cmd</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> 
        <span class="n">at_check_input</span><span class="p">()</span>
        
<span class="k">def</span> <span class="nf">at_is_ready</span><span class="p">()</span><span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">at_cmd</span>
    <span class="k">return</span> <span class="n">at_cmd</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># send AT command - only after prev. command has finished.</span>
<span class="c1"># ...may wait for several seconds, e.g. when connecting to WiFi, MQTT</span>

<span class="k">def</span> <span class="nf">at_send</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_ok</span><span class="p">,</span> <span class="n">at_error</span><span class="p">,</span> <span class="n">at_errorcode</span><span class="p">,</span> <span class="n">at_cmd</span>
    
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="n">at_ok</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">at_error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">at_errorcode</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">at_cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># remove parameters</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">at_cmd</span> <span class="o">=</span> <span class="n">cmd</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;..&quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>        
    <span class="n">sendAT</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">at_init_ESP</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">wifi_connected</span><span class="p">,</span> <span class="n">mqtt_connected</span><span class="p">,</span> <span class="n">input_buffer</span>
    <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>         <span class="c1"># wake-up</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RESTORE&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># restore to factory settings</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>     <span class="c1"># reset, restart</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">buf</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+CWMODE=1&#39;</span><span class="p">)</span> <span class="c1"># set to STA mode</span>
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">at_wifi_connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_errorcode</span>
    
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">ssid</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">password</span><span class="p">))</span>
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">at_ok</span> <span class="ow">and</span> <span class="n">wifi_connected</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;wifi connection failed&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">at_errorcode</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">at_wifi_connected</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">wifi_connected</span>
    <span class="k">return</span> <span class="n">wifi_connected</span>

<span class="k">def</span> <span class="nf">at_get_mac_address</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">mac_address</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTAMAC?&#39;</span><span class="p">)</span>
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mac_address</span>

<span class="k">def</span> <span class="nf">at_get_ip_address</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">ip_adress</span><span class="p">,</span> <span class="n">wifi_connected</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wifi_connected</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTA?&#39;</span><span class="p">)</span>
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ip_address</span>

<span class="k">def</span> <span class="nf">at_mqtt_set_userconfig</span><span class="p">(</span><span class="n">scheme</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+MQTTUSERCFG=0,</span><span class="si">{a}</span><span class="s1">,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,&quot;</span><span class="si">{c}</span><span class="s1">&quot;,&quot;</span><span class="si">{d}</span><span class="s1">&quot;,0,0,&quot;&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">scheme</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">client_id</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">password</span>
    <span class="p">))</span>

<span class="k">def</span> <span class="nf">at_mqtt_connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">reconnect</span><span class="p">):</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+MQTTCONN=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,</span><span class="si">{b}</span><span class="s1">,</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">host</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">port</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">reconnect</span>
    <span class="p">))</span>

<span class="k">def</span> <span class="nf">at_mqtt_connected</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">mqtt_connected</span>
    <span class="k">return</span> <span class="n">mqtt_connected</span>

<span class="c1">#def at_mqtt_start():</span>
<span class="c1">#    global mqtt_connected</span>
<span class="c1">#    </span>
<span class="c1">#    at_mqtt_set_userconfig(1, &#39;gw-&#39;+mac_address, mqtt_user, mqtt_password)</span>
<span class="c1">#    at_mqtt_connect(mqtt_host, mqtt_port, 1)</span>
<span class="c1">#    if at_ok:</span>
<span class="c1">#        mqtt_connected = True</span>
<span class="c1">#        display.show(&#39;M&#39;)</span>
<span class="c1">#        on_mqtt_connected()</span>

<span class="k">def</span> <span class="nf">at_mqtt_publish</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">retain</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+MQTTPUB=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,</span><span class="si">{c}</span><span class="s1">,</span><span class="si">{d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">topic</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">qos</span><span class="p">,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">retain</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">))</span>
    
<span class="k">def</span> <span class="nf">at_mqtt_subscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qos</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+MQTTSUB=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,</span><span class="si">{b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">topic</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">qos</span>
    <span class="p">))</span>

<span class="c1"># function (topic: str, msg: str)</span>
<span class="k">def</span> <span class="nf">at_set_on_mqtt_message</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">on_mqtt_message</span>
    <span class="n">on_mqtt_message</span> <span class="o">=</span> <span class="n">function</span>
</pre></div>
</div>
</div>
</div>
<p>Ik heb geen ervaring met exceptions in Python; en in het bijzonder niet met het meegeven van parameters aan exceptions. Eigenlijk moet dit wel getest worden!</p>
<p>Is de WiFi-verbinding nodig voor het opvragen van het MAC-adres, of kunnen we dat gewoon als een losse functie aanbieden? (Ik zou verwachten dat zodra je de WiFi-mode gezet hebt voor “station” (is eindpunt), het MAC-adres gedefinieerd is.)</p>
<p>Je moet in het geval van het opvragen van het mac-adres, wel wachten tot de at-functie klaar is: eerder is het resultaat niet bekend cq. gecommuniceerd. Je kunt deze functie aanroepen na het initialiseren van de ESP. (Of, eigenlijk, na het zetten van de “station” mode - daarvoor moeten we eigenlijk ook een aparte functie maken: <code class="docutils literal notranslate"><span class="pre">at_set_wifi_mode(int)</span></code>). Hierbij is mode=1 de “station mode”; mode=0 schakelt WiFi uit.)</p>
<p>Het MAC-adres hebben we nodig voor bijv. een unieke identificatie als IoT-gateway of IoT-knoop.</p>
<p>(Het IP-adres is in veel gevallen niet nodig. Ook daarvoor kunnen we beter een aparte functie definiëren.)</p>
<p>In principe geldt na de aanroep (en terugkeer) van at_wifi_connect dat er een wifi-verbinding is. Als het niet lukt om een verbinding te maken, dan moet deze functie een (i) foutresultaat opleveren; (ii) of, een exception raisen. (Wat een rotwoord… “signaleren” lijkt mij beter.)</p>
<p>(Het lijkt mij geen zin hebben om een asynchrone versie van wifi_connect aan te bieden: als er geen verbinding is, kun je toch niets met binnenkomende lokale berichten.)</p>
<ul class="simple">
<li><p>initialiseren van ESP-module</p></li>
<li><p>initialieren van WiFi; verbinden met WiFi netwerk (ssid, passwd)</p>
<ul>
<li><p>als de verbinding niet lukt: opnieuw proberen???</p></li>
</ul>
</li>
<li><p>configureren van mqtt; verbinden met mqtt broker (user, passwd)</p></li>
<li><p>…als mqtt verbinding wegvalt: opnieuw verbinden.</p></li>
</ul>
<p>Wat moeten we doen als de WiFi verbinding niet lukt? Opnieuw proberen? (en als deze wegvalt?)</p>
<ul class="simple">
<li><p>nb: als je een lang-draaiende gateway of IoT-node hebt, dan kan het voorkomen dat de WiFi-verbinding wegvalt, bijvoorbeeld doordat het base-station opnieuw opgestart wordt. In dat geval moet het wegvallen van de verbinding gesignaleerd worden - en moet geprobeerd worden de verbinding opnieuw te maken, waarschijnlijk met een voldoend grote wachttijd.</p></li>
</ul>
<p>Wat moeten we doen als de MQTT verbinding niet lukt? (en als de verbinding wegvalt?)</p>
<p>Wat moeten we in de loop doen?</p>
<p>Het onderstaande is een demonstratie van functie-variabelen in Python. Dit werkt zoals verwacht.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">demo</span> <span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hi there &quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
    
<span class="n">demo</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">demo</span>
<span class="n">test</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hi there y
Hi there x
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># AT-ESP gateway for microbit iot-network</span>

<span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">espat</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="n">wifi_ssid</span> <span class="o">=</span> <span class="s1">&#39;infvo-iot&#39;</span>
<span class="n">wifi_password</span> <span class="o">=</span> <span class="s1">&#39;LISP77(Midas&#39;</span>
<span class="n">mqtt_user</span> <span class="o">=</span> <span class="s1">&#39;mqtttest&#39;</span>
<span class="n">mqtt_password</span> <span class="o">=</span> <span class="s1">&#39;testmqtt&#39;</span>
<span class="n">mqtt_host</span> <span class="o">=</span> <span class="s1">&#39;infvopedia.nl&#39;</span>
<span class="n">mqtt_port</span> <span class="o">=</span> <span class="mi">1883</span>

<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>

<span class="c1"># logging is done by radio messages to the logging microbit</span>
<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c1"># default handler for incoming mqtt messages</span>
<span class="c1"># should be re-defined by ????</span>
<span class="k">def</span> <span class="nf">on_mqtt_message</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;mqtt-topic: &#39;</span> <span class="o">+</span> <span class="n">topic</span><span class="p">)</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;mqtt-msg:&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

<span class="c1"># should this be done in the library??? (or here, in the gateway?)</span>
<span class="n">uart</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">pin8</span><span class="p">,</span> <span class="n">rx</span><span class="o">=</span><span class="n">pin12</span><span class="p">)</span> <span class="c1"># connect to ESP8266</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
<span class="n">at_init_ESP</span><span class="p">()</span>
<span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">at_wifi_connected</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">at_wifi_connect</span><span class="p">(</span><span class="n">wifi_ssid</span><span class="p">,</span> <span class="n">wifi_password</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">at_errorcode</span><span class="p">())</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
        <span class="n">at_init_ESP</span><span class="p">()</span>
        <span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>

<span class="n">mac_address</span> <span class="o">=</span> <span class="n">at_get_mac_address</span><span class="p">()</span>
<span class="n">log</span><span class="p">(</span><span class="s1">&#39;My mac-addr: &#39;</span> <span class="o">+</span> <span class="n">mac_address</span><span class="p">)</span>

<span class="n">at_mqtt_set_userconfig</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;gw-&#39;</span><span class="o">+</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">mqtt_user</span><span class="p">,</span> <span class="n">mqtt_password</span><span class="p">)</span>
<span class="n">display</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">at_mqtt_connected</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">at_wifi_connected</span><span class="p">():</span>
            <span class="n">reset</span><span class="p">()</span>
        <span class="n">at_mqtt_connect</span><span class="p">(</span><span class="n">mqtt_host</span><span class="p">,</span> <span class="n">mqtt_port</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">at_set_on_mqtt_message</span><span class="p">(</span><span class="n">on_mqtt_message</span><span class="p">)</span>
        <span class="n">at_mqtt_subscribe</span><span class="p">(</span><span class="s1">&#39;microbit/input&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">button_a</span><span class="o">.</span><span class="n">was_pressed</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">at_mqtt_connected</span><span class="p">():</span>
            <span class="n">at_mqtt_publish</span><span class="p">(</span><span class="s1">&#39;microbit/output&#39;</span><span class="p">,</span> <span class="s1">&#39;button A&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">at_check_input</span><span class="p">()</span>
    
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Inhoud
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#programmeren-van-de-micro-bit-als-gateway">Programmeren van de micro:bit als gateway</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#uitleg-van-de-gateway-code">Uitleg van de gateway-code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-loop">Main loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gebruik-van-timers-alternatief">Gebruik van timers? Alternatief?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#on-data-received-functie">on data received functie</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging">Debugging</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gebruik-van-radio-voor-logging-debugging">Gebruik van radio voor logging, debugging</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#voorbeelden">Voorbeelden</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#voorbereidden-van-de-mqtt-connect">Voorbereidden van de MQTT connect</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#at-messages">AT messages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mqtt">MQTT</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organiseren-als-library">Organiseren als library</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#atesp-library">atesp library</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
Door Eelco Dijkstra
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>