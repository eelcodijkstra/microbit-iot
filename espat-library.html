

<!DOCTYPE html>


<html lang="nl" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>ESP-AT module &#8212; IoT met de microbit</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="_static/assessment.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="_static/assessment.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/translations.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'espat-library';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Zoeken" href="search.html" />
    <link rel="next" title="ESPAT-gateway" href="espat-gateway.html" />
    <link rel="prev" title="LPP implementatie" href="lpp-software.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="nl"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Internet of Things met de micro:bit
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="inleiding.html">Inleiding</a></li>
<li class="toctree-l1"><a class="reference internal" href="overzicht.html">Overzicht</a></li>
<li class="toctree-l1"><a class="reference internal" href="bijeenkomst-1.html">Bijeenkomst 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="bijeenkomst-2.html">Bijeenkomst 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="benodigd.html">Wat heb je nodig?</a></li>
<li class="toctree-l1"><a class="reference internal" href="lpp-payload.html">LPP payload formaat</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-editor.html">Python op de microbit</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="microbit-software.html">micro:bit software</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="microbit-iotnode.html">microbit IoT-knoop</a></li>
<li class="toctree-l2"><a class="reference internal" href="microbit-logger.html">microbit-logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="lpp-software.html">LPP implementatie</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">ESP-AT module</a></li>
<li class="toctree-l2"><a class="reference internal" href="espat-gateway.html">ESPAT-gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="json.html">JSON voor de microbit</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="presentaties.html">Presentaties</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="presentatie-1.html">Presentatie-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="presentatie-2.html">Presentatie 2</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Bronopslagplaats"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fespat-library.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open een probleem"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download deze pagina">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/espat-library.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download het bronbestand"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Afdrukken naar pdf"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Volledig scherm"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Zoeken" aria-label="Zoeken" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>ESP-AT module</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Inhoud </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#at-opdrachten">AT opdrachten</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#de-library">De library</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synchrone-functies">Synchrone functies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nog-aanpassen">Nog aanpassen</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#at-string-escapes">AT string-escapes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#esp-at-library-code">ESP-AT library code</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="esp-at-module">
<h1>ESP-AT module<a class="headerlink" href="#esp-at-module" title="Permalink naar deze titel">#</a></h1>
<p>De ESP-AT module verzorgt de communicatie met de ESP8266 WiFi-(hardware)module, via de AT-opdrachten. Deze WiFi-module wordt onder andere gebruikt in de iot:bit van Elecfreaks.</p>
<p>Deze ESP-AT module vormt de basis voor de microbit ESP-AT gateway. Je kunt hiermee ook een microbit als IoT-knoop maken, zonder het gebruik van een gateway (ESP-AT IoT-node).</p>
<ul class="simple">
<li><p><a class="reference external" href="https://espressif-docs.readthedocs-hosted.com/projects/esp-at/en/release-v2.1.0.0_esp8266/Get_Started/index.html">https://espressif-docs.readthedocs-hosted.com/projects/esp-at/en/release-v2.1.0.0_esp8266/Get_Started/index.html</a></p></li>
<li><p>(iot:bit link)</p></li>
<li><p>(iot:bit github library)</p></li>
</ul>
<section id="at-opdrachten">
<h2>AT opdrachten<a class="headerlink" href="#at-opdrachten" title="Permalink naar deze titel">#</a></h2>
<p>De communicatie tussen de microbit en de ESP-module gebeurt via de seriële verbinding van de microbit.</p>
<p>Deze verbinding moet ingesteld worden op 115200 baud.</p>
<div class="admonition warning">
<p class="admonition-title">Waarschuwing</p>
<p>De seriële verbinding is op het iot:bot bordje niet beschikbaar voor communicatie met de host.
Voor foutzoeken is dat lastig: je kunt geen “logging” doen via de seriële verbinding. De ESP-AT-library gebruikt daarom voor de logging de microbit-radio. Dit kan interfereren met ander gebruik van deze radio.</p>
</div>
<p>De microbit stuurt een AT-opdracht, de ESP-module verwerkt deze, en stuurt het resultaat terug naar de microbit. De response van de ESP-module kan informatie bevatten, bijvoorbeeld over de WiFi-verbinding (IP-adres). De response van een AT-opdracht wordt altijd afgesloten met <code class="docutils literal notranslate"><span class="pre">OK</span></code> of <code class="docutils literal notranslate"><span class="pre">ERROR</span></code>, om aan te geven of de opdracht geslaagd is of niet.</p>
<p>De ESP-module stuurt ook “unsollicited” (ongevraagde) berichten, bijvoorbeeld als er een MQTT-bericht vanuit de broker ontvangen is. Ook het wegvallen van de MQTT-verbinding of van de WIFi-verbinding is een “unsollicited” bericht.</p>
<p>De ESP-module kan maar één opdracht tegelijk verwerken: je moet wachten tot de vorige opdracht klaar is, voordat je een nieuwe opdracht kunt geven. De verwerking van een opdracht kan vele seconden in beslag nemen, in het bijzonder bij het opzetten van een WiFi-verbinding of een MQTT-verbinding.</p>
<blockquote>
<div><p>Eigenlijk moet je ervoor zorgen dat tijdens het wachten op de vorige opdracht, de verwerking van lokale berichten gewoon door kan gaan.</p>
</div></blockquote>
</section>
<section id="de-library">
<h2>De library<a class="headerlink" href="#de-library" title="Permalink naar deze titel">#</a></h2>
<section id="synchrone-functies">
<h3>Synchrone functies<a class="headerlink" href="#synchrone-functies" title="Permalink naar deze titel">#</a></h3>
<p>Om ervoor te zorgen dat er niet meer dan één AT-opdracht tegelijk actief is, wacht een nieuwe opdracht altijd totdat de vorige afgerond is.</p>
<p>Dit wachten gebeurt met de functie: <code class="docutils literal notranslate"><span class="pre">wait_at_ready()</span></code>, op basis van de boolean functie <code class="docutils literal notranslate"><span class="pre">at_ready()</span></code>.
Je kunt in de event-loop er ook voor zorgen dat een at-functie altijd aangeroepen wordt als de vorige afgerond is, door het wachten in de event-loop uit te programmeren.</p>
<p>Sommige functies zijn volledig synchroon, dat wil zeggen dat deze wachten totdat de AT-opdracht compleet uitgevoerd is. Dit is bijvoorbeeld nodig voor functies die een resultaat opleveren (???)</p>
</section>
<section id="nog-aanpassen">
<h3>Nog aanpassen<a class="headerlink" href="#nog-aanpassen" title="Permalink naar deze titel">#</a></h3>
<ul class="simple">
<li><p>logging optioneel, in- en uitschakelen via een functie</p></li>
<li><p>de functie <code class="docutils literal notranslate"><span class="pre">at_wifi_connect()</span></code> is helemaal synchroon - met een exception als het niet lukt. Is dit nodig? Is dit de beste oplossing?</p></li>
<li><p>hoe signaleren we dat de wifi-verbinding verbroken is? of moet de toepassing daar voortdurend op controleren?</p>
<ul>
<li><p>in de toepassing moet de functie voor het verwerken van de invoer van de ESP-module steeds aangeroepen worden; in principe kunnen we het via die functie signaleren?</p></li>
</ul>
</li>
</ul>
</section>
<section id="at-string-escapes">
<h3>AT string-escapes<a class="headerlink" href="#at-string-escapes" title="Permalink naar deze titel">#</a></h3>
<p>In een AT-opdracht kunnen <em>strings</em> voorkomen, genoteerd tussen dubbele quotes.
In zulke strings moeten de volgende tekens van een escape-code (<code class="docutils literal notranslate"><span class="pre">\</span></code>) voorzien zijn:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">\&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">,</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">\,</span></code>  (!!)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">\\</span></code></p></li>
</ul>
<p>Dit geldt voor de MQTT-string, maar ook voor MQTT topics, WiFi netwerknaam, WiFi wachtwoord, MQTT gebruikersnaam, MQTT wachtwoord, enz.</p>
<p>De library zorgt voor deze escape-codes: de applicatie moet de string <em>zonder escape-codes</em> aanbieden.</p>
</section>
</section>
<section id="esp-at-library-code">
<span id="espat-library-code"></span><h2>ESP-AT library code<a class="headerlink" href="#esp-at-library-code" title="Permalink naar deze titel">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ESP-AT library for iot:bit</span>

<span class="kn">from</span> <span class="nn">microbit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">radio</span>

<span class="c1"># global variables</span>

<span class="n">at_ok</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">at_error</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">at_errorcode</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">at_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">ip_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">mac_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">netmask</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="c1"># logging by radio to logging microbit</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">txt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">:</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">250</span><span class="p">])</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="mi">250</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">radio</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

<span class="n">radio</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
<span class="n">radio</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>

<span class="c1"># low-level: send command to ESP module</span>

<span class="k">def</span> <span class="nf">sendAT</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{a}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">command</span><span class="p">))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">escape_string</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\&quot;</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">,&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_cmd</span><span class="p">,</span> <span class="n">at_ok</span><span class="p">,</span> <span class="n">at_error</span><span class="p">,</span> <span class="n">at_errorcode</span><span class="p">,</span> <span class="n">wifi_connected</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">gateway_address</span><span class="p">,</span> <span class="n">netmask</span>
    <span class="k">global</span> <span class="n">mqtt_connected</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span>

    <span class="c1"># first, handle unsollicited messages</span>
    <span class="c1"># see: AT Messages</span>

    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI CONNECTED&#39;</span><span class="p">):</span>
        <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI DISCONNECT&#39;</span><span class="p">):</span>
        <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WIFI GOT IP&#39;</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+MQTTCONNECTED:&quot;</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mqtt connected&quot;</span><span class="p">)</span>
        <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+MQTTDISCONNECTED:&quot;</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mqtt disconnected&quot;</span><span class="p">)</span>
        <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> 

    <span class="c1"># next,  handle complex (or all?) commands</span>

    <span class="k">if</span> <span class="n">at_cmd</span> <span class="o">==</span> <span class="s1">&#39;AT+CWJAP=&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CWJAP:&#39;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="n">at_errorcode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">&#39;error: &#39;</span> <span class="o">+</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">at_cmd</span> <span class="o">==</span> <span class="s2">&quot;AT+CIPSTAMAC?&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTAMAC:&quot;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">mac_address</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mac-addr:&quot;</span> <span class="o">+</span> <span class="n">mac_address</span><span class="p">)</span>
            <span class="k">return</span>
        
    <span class="k">elif</span> <span class="n">at_cmd</span> <span class="o">==</span> <span class="s2">&quot;AT+CIPSTA?&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:ip:&quot;</span><span class="p">):</span>
            <span class="n">ip_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;ip-addr:&quot;</span> <span class="o">+</span> <span class="n">ip_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:gateway:&quot;</span><span class="p">):</span>
            <span class="n">gateway_address</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;gateway-addr:&quot;</span> <span class="o">+</span> <span class="n">gateway_address</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+CIPSTA:netmask:&quot;</span><span class="p">):</span>
            <span class="n">netmask</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;netmask:&quot;</span> <span class="o">+</span> <span class="n">netmask</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
  
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">at_cmd</span><span class="p">):</span>
        <span class="c1"># echo</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
        <span class="n">at_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">at_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
        <span class="n">at_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">at_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span>
    
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;unexpected-3: &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">log_mqtt_message</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;msg-topic: &#39;</span> <span class="o">+</span> <span class="n">topic</span><span class="p">)</span>
    <span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
<span class="n">on_mqtt_message</span> <span class="o">=</span> <span class="n">log_mqtt_message</span> <span class="c1"># default message handler</span>

<span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">at_check_input</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">input_buffer</span>
    
    <span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">in_bytes</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">in_bytes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_buffer</span> <span class="o">+=</span> <span class="n">in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+MQTTSUBRECV:0&#39;</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span> 
            <span class="k">return</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="n">datasize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;mqtt-datasize: &quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">datasize</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># incl. CRLF</span>
            <span class="k">return</span>
        <span class="n">totalsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">datasize</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="c1"># 3 comma&#39;s and CRLF</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">totalsize</span><span class="p">:]</span>
        <span class="n">on_mqtt_message</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">datasize</span><span class="p">])</span>
        <span class="k">return</span>
        
    <span class="n">eol_pos</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eol_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eol_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># get line and</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="p">[</span><span class="n">eol_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove from input_buffer</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">handle_inputline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="c1"># wait until last at-command is finished (OR or ERROR)</span>
<span class="k">def</span> <span class="nf">wait_at_ready</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">at_cmd</span>
    <span class="k">while</span> <span class="n">at_cmd</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> 
        <span class="n">at_check_input</span><span class="p">()</span>
        
<span class="k">def</span> <span class="nf">at_is_ready</span><span class="p">()</span><span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">at_cmd</span>
    <span class="k">return</span> <span class="n">at_cmd</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># send AT command - only after prev. command has finished.</span>
<span class="c1"># ...may wait for several seconds, e.g. when connecting to WiFi, MQTT</span>

<span class="k">def</span> <span class="nf">at_send</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_ok</span><span class="p">,</span> <span class="n">at_error</span><span class="p">,</span> <span class="n">at_errorcode</span><span class="p">,</span> <span class="n">at_cmd</span>
    
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="n">at_ok</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">at_error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">at_errorcode</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">at_cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># remove parameters</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">at_cmd</span> <span class="o">=</span> <span class="n">cmd</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;..&quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>        
    <span class="n">sendAT</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">at_init_ESP</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">wifi_connected</span><span class="p">,</span> <span class="n">mqtt_connected</span><span class="p">,</span> <span class="n">input_buffer</span>
    <span class="n">wifi_connected</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mqtt_connected</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">input_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>         <span class="c1"># wake-up</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RESTORE&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># restore to factory settings</span>
    <span class="n">sendAT</span><span class="p">(</span><span class="s1">&#39;AT+RST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>     <span class="c1"># reset, restart</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">buf</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+CWMODE=1&#39;</span><span class="p">)</span> <span class="c1"># set to STA mode</span>
    <span class="n">wait_at_ready</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">at_wifi_connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">at_errorcode</span>
    
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+CWJAP=&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span><span class="o">=</span><span class="n">escape_string</span><span class="p">(</span><span class="n">ssid</span><span class="p">),</span> 
        <span class="n">b</span><span class="o">=</span><span class="n">escape_string</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">at_ok</span> <span class="ow">and</span> <span class="n">wifi_connected</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;wifi connection failed&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">at_errorcode</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">at_wifi_connected</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">wifi_connected</span>
    <span class="k">return</span> <span class="n">wifi_connected</span>

<span class="k">def</span> <span class="nf">at_get_mac_address</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">mac_address</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTAMAC?&#39;</span><span class="p">)</span>
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mac_address</span>

<span class="k">def</span> <span class="nf">at_get_ip_address</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">ip_adress</span><span class="p">,</span> <span class="n">wifi_connected</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wifi_connected</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+CIPSTA?&#39;</span><span class="p">)</span>
    <span class="n">wait_at_ready</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ip_address</span>

<span class="k">def</span> <span class="nf">at_mqtt_set_userconfig</span><span class="p">(</span><span class="n">scheme</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+MQTTUSERCFG=0,</span><span class="si">{a}</span><span class="s1">,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,&quot;</span><span class="si">{c}</span><span class="s1">&quot;,&quot;</span><span class="si">{d}</span><span class="s1">&quot;,0,0,&quot;&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">scheme</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">escape_string</span><span class="p">(</span><span class="n">client_id</span><span class="p">),</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">escape_string</span><span class="p">(</span><span class="n">username</span><span class="p">),</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">escape_sting</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="p">))</span>

<span class="k">def</span> <span class="nf">at_mqtt_connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">reconnect</span><span class="p">):</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+MQTTCONN=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,</span><span class="si">{b}</span><span class="s1">,</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">host</span><span class="p">,</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">port</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">reconnect</span>
    <span class="p">))</span>

<span class="k">def</span> <span class="nf">at_mqtt_connected</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">mqtt_connected</span>
    <span class="k">return</span> <span class="n">mqtt_connected</span>

<span class="k">def</span> <span class="nf">at_mqtt_publish</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">retain</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+MQTTPUB=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,&quot;</span><span class="si">{b}</span><span class="s1">&quot;,</span><span class="si">{c}</span><span class="s1">,</span><span class="si">{d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">escape_string</span><span class="p">(</span><span class="n">topic</span><span class="p">),</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">escape_string</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">qos</span><span class="p">,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">retain</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">))</span>
    
<span class="k">def</span> <span class="nf">at_mqtt_subscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qos</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">at_send</span><span class="p">(</span><span class="s1">&#39;AT+MQTTSUB=0,&quot;</span><span class="si">{a}</span><span class="s1">&quot;,</span><span class="si">{b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">escape_string</span><span class="p">(</span><span class="n">topic</span><span class="p">),</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">qos</span>
    <span class="p">))</span>

<span class="c1"># function (topic: str, msg: str)</span>
<span class="k">def</span> <span class="nf">at_set_on_mqtt_message</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">on_mqtt_message</span>
    <span class="n">on_mqtt_message</span> <span class="o">=</span> <span class="n">function</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="lpp-software.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">vorige</p>
        <p class="prev-next-title">LPP implementatie</p>
      </div>
    </a>
    <a class="right-next"
       href="espat-gateway.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">volgende</p>
        <p class="prev-next-title">ESPAT-gateway</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Inhoud
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#at-opdrachten">AT opdrachten</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#de-library">De library</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synchrone-functies">Synchrone functies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nog-aanpassen">Nog aanpassen</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#at-string-escapes">AT string-escapes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#esp-at-library-code">ESP-AT library code</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
Door Eelco Dijkstra
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>